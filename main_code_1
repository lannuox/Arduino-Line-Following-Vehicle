#include <LiquidCrystal.h>

// ---------------- LCD ----------------
LiquidCrystal lcd(8, 9, 4, 5, 6, 7);

// ---------------- Pin å®šä¹‰ ----------------
// IR Sensors (å®é™…ä½œä¸º digital input)
#define IR_LEFT   A3
#define IR_MID    A2
#define IR_RIGHT  A1

// Wheel Encoders (digital)
#define ENC_LEFT  A5
#define ENC_RIGHT A4

// Motor pins
#define L_PWM   11
#define R_PWM   3
#define L_IN1   1
#define L_IN2   2
#define R_IN1   12
#define R_IN2   13

// ---------------- å°è½¦å‚æ•° ----------------
const int baseSpeed = 100;        // é»˜è®¤ PWM é€Ÿåº¦
const float wheelCirc = 75.0;     // mm per revolution
const int encoderPPR = 40;        // 20 ç©º + 20 å® = 40 pulses

// ---------------- ç¼–ç å™¨å˜é‡ ----------------
volatile long leftCount = 0;
volatile long rightCount = 0;

// ---------------- æ—¶é—´è®¡ç®— ----------------
unsigned long startTime;

// ==================== ä¸­æ–­å‡½æ•° ====================
void leftEncoderISR() {
  leftCount++;
}

void rightEncoderISR() {
  rightCount++;
}

// ==================== ç”µæœºæ§åˆ¶å‡½æ•° ====================
void setMotor(int lpwm, int rpwm) {
  // å·¦è½®å‰è¿›
  if (lpwm >= 0) {
    digitalWrite(L_IN1, HIGH);
    digitalWrite(L_IN2, LOW);
  } else {
    digitalWrite(L_IN1, LOW);
    digitalWrite(L_IN2, HIGH);
    lpwm = -lpwm;
  }

  // å³è½®å‰è¿›
  if (rpwm >= 0) {
    digitalWrite(R_IN1, HIGH);
    digitalWrite(R_IN2, LOW);
  } else {
    digitalWrite(R_IN1, LOW);
    digitalWrite(R_IN2, HIGH);
    rpwm = -rpwm;
  }

  analogWrite(L_PWM, constrain(lpwm, 0, 255));
  analogWrite(R_PWM, constrain(rpwm, 0, 255));
}

// ==================== è¯»å– IR Sensor ====================
void readIRSensors(bool &L, bool &M, bool &R) {
  L = digitalRead(IR_LEFT) == LOW;
  M = digitalRead(IR_MID)  == LOW;
  R = digitalRead(IR_RIGHT)== LOW;
}

// ==================== speed trimï¼ˆè®©è½¦èµ°ç›´ï¼‰====================
int speedTrim() {
  long diff = leftCount - rightCount;

  // ç®€æ˜“çº¿æ€§è¡¥å¿ï¼Œä¸ç”¨å¤ª fancyï¼Œå°è½¦å°±å–œæ¬¢æœ´å®æ— å ğŸ¤–
  return constrain(diff * 2, -30, 30);
}

// ==================== è®¡ç®—è·ç¦» ====================
float getDistanceMM() {
  float avgCount = (leftCount + rightCount) / 2.0;
  float rev = avgCount / encoderPPR;
  return rev * wheelCirc; // mm
}

// ==================== LCD æ˜¾ç¤º ====================
void updateLCD() {
  unsigned long t = (millis() - startTime) / 1000;

  lcd.setCursor(0, 0);
  lcd.print("Time: ");
  lcd.print(t);
  lcd.print("s   ");

  lcd.setCursor(0, 1);
  lcd.print("Dist: ");
  lcd.print(getDistanceMM(), 1);
  lcd.print("mm");
}

// ==================== SETUP ====================
void setup() {
  lcd.begin(16, 2);

  pinMode(IR_LEFT,  INPUT_PULLUP);
  pinMode(IR_MID,   INPUT_PULLUP);
  pinMode(IR_RIGHT, INPUT_PULLUP);

  pinMode(ENC_LEFT,  INPUT_PULLUP);
  pinMode(ENC_RIGHT, INPUT_PULLUP);

  pinMode(L_PWM, OUTPUT);
  pinMode(R_PWM, OUTPUT);
  pinMode(L_IN1, OUTPUT);
  pinMode(L_IN2, OUTPUT);
  pinMode(R_IN1, OUTPUT);
  pinMode(R_IN2, OUTPUT);

  attachInterrupt(digitalPinToInterrupt(ENC_LEFT),  leftEncoderISR,  CHANGE);
  attachInterrupt(digitalPinToInterrupt(ENC_RIGHT), rightEncoderISR, CHANGE);

  startTime = millis();

  lcd.print("Line Car Ready!");
  delay(1000);
}

// ==================== LOOP ä¸»é€»è¾‘ ====================
void loop() {
  bool L, M, R;
  readIRSensors(L, M, R);

  int trim = speedTrim(); // ç¼–ç å™¨é€Ÿåº¦è¡¥å¿

  int leftSpeed  = baseSpeed - trim;
  int rightSpeed = baseSpeed + trim;

  // ---------------- Line Following æ ¸å¿ƒé€»è¾‘ ----------------
  if (M) {
    // ä¸­ sensor åœ¨é»‘çº¿ä¸Š â†’ ç›´è¡Œ
    setMotor(leftSpeed, rightSpeed);

  } else {
    // å·¦æˆ–å³é‡é»‘çº¿ â†’ ä¿®æ­£
    if (L) {
      // å·¦ sensor é»‘çº¿ â†’ å·¦å â†’ å¾€å³çº æ­£
      setMotor(leftSpeed + 40, rightSpeed - 40);
    }
    else if (R) {
      // å³ sensor é»‘çº¿ â†’ å³å â†’ å¾€å·¦çº æ­£
      setMotor(leftSpeed - 40, rightSpeed + 40);
    }
    else {
      // ä¸‰ä¸ªéƒ½æ²¡çœ‹åˆ°é»‘çº¿ â†’ æœ‰ç‚¹æ…Œï¼ˆè¿·è·¯æ¨¡å¼ï¼‰ğŸ˜‚ â†’ åœä¸€ä¸‹
      setMotor(0, 0);
    }
  }

  updateLCD();
  delay(80); // ç¨å¾®æ…¢ä¸€ç‚¹ï¼Œè®© LCD èƒ½çœ‹æ¸…æ¥šä¸€ç‚¹
}
